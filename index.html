<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DAX Studio × CokeGPT 実務手順（Performance Analyzer → CSV抽出）</title>
  <meta name="description" content="Power BIのPerformance AnalyzerでDAXを取得し、CokeGPTで整形してDAX StudioでCSV抽出する実務手順" />

  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0d1428;
      --text:#e8eeff;
      --muted:#b7c3ff;
      --accent:#7cc4ff;
      --border:rgba(255,255,255,.12);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      /* unified sizing */
      --radius:16px;
      --pad:16px;
      --gap:12px;
    }

    *{box-sizing:border-box}
    html,body{margin:0; padding:0}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      background: radial-gradient(1200px 800px at 15% 0%, #1b2d5e 0%, var(--bg) 55%);
      color:var(--text);
      line-height:1.75;
      font-size:16px;
    }

    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{max-width:1080px; margin:0 auto; padding:28px 16px 64px}

    /* unified card */
    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: rgba(16,26,51,.72);
      padding:var(--pad);
    }

    /* typography: unified scale */
    .title{
      margin:0 0 8px;
      font-size:20px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.8;
    }

    /* nav is now a card too (shared spec) */
    .nav{
      position:sticky;
      top:0;
      z-index:10;
      margin-top:var(--gap);

      /* keep same padding as .card */
      padding:var(--pad);

      /* avoid “different component” feel */
      backdrop-filter:none;
    }
    .nav a{
      margin-right:12px;
      font-size:14px;
      color:var(--muted);
      white-space:nowrap;
    }
    .nav a:hover{color:var(--text)}

    main{margin-top:var(--gap); display:grid; gap:var(--gap)}

    section{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: rgba(16,26,51,.72);
      padding:var(--pad);
    }

    h2{
      margin:0 0 10px;
      font-size:16px;
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:baseline;
    }
    h2 .anchor{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
    }

    .note{color:var(--muted); font-size:14px; margin:0}

    .bullets{margin:10px 0 0; padding-left:0; list-style:none}
    .bullets li{margin:6px 0}
    .bullets li::before{content:"・"; margin-right:6px; color:var(--accent)}

    .callout{
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      border-radius:12px;
      padding:12px;
    }

    .imgbox{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background: var(--panel2);
    }
    .imgbox img{width:100%; height:auto; display:block}
    .caption{
      font-size:12px;
      color:var(--muted);
      padding:10px 12px;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }

    .codewrap{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
    }
    .codebar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.04);
      gap:10px;
    }
    .codebar .label{font-size:12px; color:var(--muted)}
    .btn{
      border:1px solid var(--border);
      background: rgba(124,196,255,.12);
      color: var(--text);
      border-radius:10px;
      padding:7px 10px;
      cursor:pointer;
      font-size:12px;
    }
    .btn:hover{background: rgba(124,196,255,.18)}

    pre{
      margin:0;
      padding:12px 12px;
      overflow:auto;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.6;
      color:#eaf0ff;
      white-space:pre;
      tab-size:2;
    }

    .faq{margin-top:8px}
    details{
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(0,0,0,.12);
      padding:10px 12px;
      margin:8px 0;
    }
    summary{cursor:pointer; color:var(--text); font-weight:800}
    .small{font-size:13px; color:var(--muted); margin:8px 0 0}

    footer{
      margin-top:14px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
      opacity:.9;
    }

    @media (max-width: 520px){
      .nav{overflow:auto}
      .nav::-webkit-scrollbar{height:0}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="card">
      <h1 class="title">DAX Studio × CokeGPT 実務手順（Performance Analyzer → CSV抽出）</h1>
      <p class="subtitle">
        Power BIのデータレイク接続モデルが巨大で、画面操作やエクスポートが現実的に回らないケースに対して、
        「Performance AnalyzerでDAXクエリ取得 → CokeGPTで整形 → DAX Studioで実行 → グリッドからCSV保存」
        を標準手順として固定する。
      </p>
    </header>

    <nav class="card nav">
      <a href="#goal">目的</a>
      <a href="#workflow">手順</a>
      <a href="#prompt">CokeGPTプロンプト</a>
      <a href="#faq">よくある失敗</a>
      <a href="#refs">参照</a>
    </nav>

    <main>
      <section id="goal">
        <h2><span class="anchor">#goal</span> 目的</h2>
        <ul class="bullets">
          <li>Power BI上で必要なデータを「欲しい粒度・列」で取り出したいが、データ量が大きく、通常のエクスポートが制約に当たりやすい。</li>
          <li>Power BIのパフォーマンス アナライザーで「実際にビジュアルが叩いているDAXクエリ」を取得し、別ツール（DAX Studio）で再実行してCSV化する。</li>
          <li>取得したDAXクエリはそのままだと不要要素（例: TOPN(501) 等）が混入するため、CokeGPTで機械的に整形してから使う。</li>
        </ul>
        <p class="note">
          パフォーマンス アナライザーで各ビジュアルのDAXクエリをコピーできることはMicrosoft Learnにも記載がある。
          <a href="https://learn.microsoft.com/ja-jp/power-bi/create-reports/performance-analyzer" target="_blank" rel="noopener">[Source]</a>
        </p>
      </section>

      <section id="workflow">
        <h2><span class="anchor">#workflow</span> 手順（Power BI → CokeGPT → DAX Studio → CSV）</h2>

        <div class="callout">
          <ul class="bullets">
            <li>Power BI Desktopで、欲しいデータが表示されるビジュアル（テーブル/マトリクス等）を表示する。</li>
            <li>「パフォーマンス アナライザー」を開き、記録して対象ビジュアルを更新する。</li>
            <li>対象ビジュアルのログから「クエリのコピー」でDAXクエリを取得する。</li>
            <li>取得したDAXクエリをCokeGPTに渡し、整形後のDAXクエリだけを出力させる（プロンプトは下記固定）。</li>
            <li>DAX Studio（社内データレイク接続のモデルに接続済みの状態）へ、CokeGPTの出力DAXを貼り付けて実行する。</li>
            <li>結果グリッドをCSVとして保存する。</li>
          </ul>
        </div>

        <div class="imgbox">
          <img
            src="./performance-analyzer.png"
            alt="Power BI Desktopの画面。リボンの「パフォーマンス アナライザー」と右ペイン内の「クエリのコピー」が赤枠で強調されているスクリーンショット。"
            loading="lazy"
          />
          <div class="caption">
            「パフォーマンス アナライザー」「クエリのコピー」の位置が赤枠で示されたスクリーンショット（リポジトリ同梱）。
          </div>
        </div>
      </section>

      <section id="prompt">
        <h2><span class="anchor">#prompt</span> CokeGPT 整形プロンプト（固定）</h2>
        <p class="note">
          運用ルールは単純。「# Target Query」より下に、Performance AnalyzerでコピーしたDAXクエリ全文を貼るだけ。
          CokeGPTの出力は「コードブロック内のDAXクエリのみ」が返る前提。
        </p>

        <div class="codewrap" data-copywrap>
          <div class="codebar">
            <div class="label">コピペ用（このままCokeGPTに渡す）</div>
            <button class="btn" type="button" data-copybtn>コピー</button>
          </div>
          <pre data-codetext># Role
あなたはDAXエンジニアリングの専門家です。提示されたDAXクエリを、VertiPaqエンジンに最適化された最速の集計クエリに書き換えてください。

# Task Rule
以下のステップに従って、リファクタリングを機械的に実行してください。

## Step 1: 不要列の物理的削除
以下の条件に該当する列を、SUMMARIZECOLUMNSの引数から完全に削除してください。
- 列名の末尾が「ID」「Code」「Sequence」「OrderKey」であるもの
- 列名が「IsGrandTotalRowTotal」であるもの

## Step 2: 構文の簡素化
1. 「TOPN句」および「ORDER BY句」をすべて削除し、全件抽出に変更してください。
2. フィルター条件はすべて「DEFINE」句内の「VAR」として定義してください。
3. フィルターには `TREATAS` を優先的に使用してください。

## Step 3: 動的フィルタの自動注入（重要）
元のクエリを解析し、以下のロジックを必ず実行してコードに組み込んでください。
1. **時間軸の特定**: 列名に「Year」「Date」「Calendar」を含む、または年次データを表す列（[TimeCol]と呼称）を特定してください。
2. **空白除外ロジック**: 特定した[TimeCol]に対し、必ず `VAR __FilterNoBlank = FILTER(ALL([TimeCol]), NOT ISBLANK([TimeCol]))` を定義してください。
3. **反映**: `SUMMARIZECOLUMNS` のフィルタ引数セクションに、この `__FilterNoBlank` を必ず含めてください。該当する列が一切ない場合のみ、この手順をスキップしてください。

## Step 4: 出力の構造化
SUMMARIZECOLUMNS内は、以下の順序で記述してください。
1. グループ化列（'テーブル'[列名]）をテーブルごとにまとめて記述。
2. Step 3で作った変数を含む、すべてのフィルタ用変数を記述。
3. メジャーを "名前", [メジャー名] の形式で記述（メジャーにはテーブル名を付けないこと）。

# Output Format
- 説明、挨拶、補足、考察は一切禁止します。
- リファクタリング後のDAXクエリのみをコードブロックで出力してください。

# Target Query
// DAX Query
DEFINE
	VAR __DS0FilterTable = 
		TREATAS({"202301"}, '445 Time'[WeekDescription])

	VAR __DS0Core = 
		SUMMARIZECOLUMNS(
			'445 Time'[YearDescription],
			'445 Time'[YearID],
			'445 Time'[QuarterDescription],
			'445 Time'[QuarterID],
			'445 Time'[PeriodDescription],
			'445 Time'[WeekDescription],
			'445 Time'[WeekID],
			'McD'[McD],
			'PM_RPP Channel'[PMChannelGroupCategoryName],
			'PM_RPP Channel'[PMChannelGroupCategorySequence],
			'PM_RPP Channel'[PMChannelGroupName],
			'PM_RPP Channel'[PMChannelGroupSequence],
			'Account'[KeyAccountTypeName],
			'Account'[KeyAccountTypeSequence],
			'Account'[AccountGroupCategoryName],
			'Account'[AccountGroupCategoryCode],
			'Account'[AccountGroupName],
			'Account'[AccountGroupCode],
			'Bottler'[All_Japan],
			'Bottler'[AreaGroupName],
			'Bottler'[AreaGroupSequence],
			'Bottler'[AreaName],
			'Bottler'[AreaSequence],
			'Bottler'[BottlerName],
			'Bottler'[BottlerSequence],
			'Bottler'[RegionName],
			'Bottler'[RegionSequence],
			'Bottler'[SubRegionName],
			'Product'[CategoryName],
			'Product'[Category_OrderKey],
			'Product'[PMBrandGroupName],
			'Product'[PMBrandGroupSequence],
			'Product'[PMBrandName],
			'Product'[PMBrandSequence],
			'Product'[BeverageCategoryName],
			'Product'[BeverageCategoryCode],
			'Product'[BeverageSubCategoryName],
			'Product'[BeverageSubCategory_OrderKey],
			'Product'[TrademarkName],
			'Product'[TM_OrderKey],
			'Product'[BrandName],
			'Product'[Brand_OrderKey],
			'Product'[BeverageProductGroup1Name],
			'Product'[BPGroup1_OrderKey],
			'Product'[BeverageProductGroup2Name],
			'Product'[BPGroup2_OrderKey],
			'Product'[BeverageProductGroupName],
			'Product'[BPGroup_OrderKey],
			'Product'[BeverageProductName],
			'Product'[BevProduct_OrderKey],
			'Product'[ProductGroupCategoryName],
			'Product'[ProductGroupName],
			'Product'[ProductGroup2_OrderKey],
			'Product'[ProductName],
			'Product'[ServiceTypeName],
			'Product'[ServiceTypeCode],
			'Product'[PackageTypeName],
			'Product'[PackageType_OrderKey],
			'Product'[PackageSizeGroupName],
			'Product'[PackageSize1_OrderKey],
			'Product'[PackageSizeName],
			'Product'[PackageSize2_OrderKey],
			'Product'[PackageName],
			'Product'[Package_OrderKey],
			'Product'[MultiTypeName],
			'Product'[MultiTypeSequence],
			'Product'[ServingName],
			'Product'[ServingCode],
			__DS0FilterTable,
			"UNT", 'Volume'[UNT],
			"PC", 'Volume'[PC],
			"CT", 'Volume'[CT],
			"PT", 'Volume'[PT],
			"Btlr_Net_Rev__bef_Bulk_Disc", 'Finance'[Btlr Net Rev. bef Bulk Disc]
		)</pre>
        </div>

        <p class="small">
          注意：上のサンプルはテンプレとして残しているだけ。運用では「# Target Query」より下を毎回置き換える。
        </p>
      </section>

      <section id="faq">
        <h2><span class="anchor">#faq</span> よくある失敗（原因が切れるものだけ）</h2>

        <div class="faq">
          <details>
            <summary>結果が501件しか出ない</summary>
            <p class="small">
              ・CokeGPTの出力に TOPN(501, …) が残っている。<br/>
              ・Performance Analyzer由来のクエリにTOPN(501)が入る例は実際に報告がある。
              <a href="https://community.powerbi.com/t5/Desktop/Remove-TOPN-from-query/td-p/2637768" target="_blank" rel="noopener">[Source]</a>
            </p>
          </details>

          <details>
            <summary>不要な列が消えない</summary>
            <p class="small">
              ・削除対象は「末尾が ID / Code / Sequence / OrderKey」と「IsGrandTotalRowTotal」だけ。命名がその規則に当たらない列は残る（仕様）。
            </p>
          </details>

          <details>
            <summary>時間軸の空白除外が入らない</summary>
            <p class="small">
              ・列名に Year / Date / Calendar を含む列が検出できないと Step 3 はスキップされる（仕様）。<br/>
              ・対象の時間列の命名が規則外なら、TimeCol判定に引っかからない。
            </p>
          </details>

          <details>
            <summary>Power BIで見ている結果と一致しない</summary>
            <p class="small">
              ・フィルタ文脈（TREATAS 等）が不足している可能性が高い。<br/>
              ・Performance Analyzerでコピーしたクエリに含まれていたフィルタVARが、整形後に落ちていないか確認する。
            </p>
          </details>
        </div>
      </section>

      <section id="refs">
        <h2><span class="anchor">#refs</span> 参照（最小限）</h2>
        <ul class="bullets">
          <li>Performance Analyzer（Microsoft Learn）: <a href="https://learn.microsoft.com/ja-jp/power-bi/create-reports/performance-analyzer" target="_blank" rel="noopener">https://learn.microsoft.com/ja-jp/power-bi/create-reports/performance-analyzer</a> <a href="https://learn.microsoft.com/ja-jp/power-bi/create-reports/performance-analyzer" target="_blank" rel="noopener">[Source]</a></li>
          <li>TOPN(501) 混入の実例（コミュニティ）: <a href="https://community.powerbi.com/t5/Desktop/Remove-TOPN-from-query/td-p/2637768" target="_blank" rel="noopener">https://community.powerbi.com/t5/Desktop/Remove-TOPN-from-query/td-p/2637768</a> <a href="https://community.powerbi.com/t5/Desktop/Remove-TOPN-from-query/td-p/2637768" target="_blank" rel="noopener">[Source]</a></li>
          <li>DAX Studio ドキュメント入口: <a href="https://daxstudio.org/docs/intro/" target="_blank" rel="noopener">https://daxstudio.org/docs/intro/</a> <a href="https://daxstudio.org/docs/intro/" target="_blank" rel="noopener">[Source]</a></li>
        </ul>
      </section>

      <footer>
        公開サイトの更新は index.html を差し替えてコミットするだけ（GitHub Pagesが自動更新）。
      </footer>
    </main>
  </div>

  <script>
    (function(){
      const wrap = document.querySelector('[data-copywrap]');
      if(!wrap) return;
      const btn = wrap.querySelector('[data-copybtn]');
      const pre = wrap.querySelector('[data-codetext]');
      if(!btn || !pre) return;

      btn.addEventListener('click', async () => {
        const text = pre.textContent;
        try{
          await navigator.clipboard.writeText(text);
          const old = btn.textContent;
          btn.textContent = 'コピー済み';
          setTimeout(()=> btn.textContent = old, 1000);
        }catch(e){
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          const old = btn.textContent;
          btn.textContent = 'コピー済み';
          setTimeout(()=> btn.textContent = old, 1000);
        }
      });
    })();
  </script>
</body>
</html>
